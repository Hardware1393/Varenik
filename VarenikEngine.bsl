// ==========================================
// Varenik Engine v1.0 - Ultimate Runtime
// Добавлено: Поддержка классов, Конструкторы, Системные фишки Puppy
// ==========================================

Перем ПамятьОбъектов; // Хранилище для экземпляров классов (Heap)
Перем СистемныеПеременные;

Процедура ИнициализироватьДвижок()
    ПамятьОбъектов = Новый Соответствие;
    СистемныеПеременные = Новый Структура;
    СистемныеПеременные.Вставить("Версия", "1.0-Puppy");
    СистемныеПеременные.Вставить("ЗанятоПамяти", 0);
КонецПроцедуры

// Основной цикл выполнения
// Параметры:
//   ДеревоПрограммы - Массив - Объектное дерево команд исполнения
Процедура ИсполнитьКод(ДеревоПрограммы) Экспорт
    ИнициализироватьДвижок();
    
    Для Каждого Команда Из ДеревоПрограммы Цикл
        
        // --- Фишка: Обработка оператора NEW (Java-стиль) ---
        Если Команда.Action = "NEW_OBJECT" Тогда
            СоздатьОбъект(Команда.ClassName, Команда.VarName);
            
        // --- Фишка: Прямой вызов системных утилит Puppy ---
        ИначеЕсли Команда.Action = "SYS_CALL" Тогда
            ВыполнитьСистемнуюКоманду(Команда.CommandName);
            
        // --- Фишка: Try-Catch-Finally (Гибрид) ---
        ИначеЕсли Команда.Action = "TRY_BLOCK" Тогда
            ИсполнитьБезопасно(Команда.SubCommands);
        Иначе
            // Неизвестная команда - пропускаем
            Продолжить;
        КонецЕсли;
    КонецЦикла;
КонецПроцедуры

// Реализация тех самых 60+ функций (Системный блок)
// Параметры:
//   ИмяКоманды - Строка - Название системной команды
Процедура ВыполнитьСистемнуюКоманду(ИмяКоманды)
    // 1. Фишка: Работа с расширением .bexe как с пакетом
    Если ИмяКоманды = "ExtractBexe" Тогда
        // Эмуляция распаковки SFS-слоя в RAM
        Сообщить("Varenik: Распаковка .bexe слоя в оперативную память...");
        
    // 2. Фишка: Проверка "Puppy-совместимости"
    ИначеЕсли ИмяКоманды = "CheckRunlevel" Тогда
        Сообщить("Varenik: Текущий уровень запуска - RAM-Mode");
        
    // 3. Фишка: Низкоуровневый вывод в консоль (Java System.out)
    ИначеЕсли ИмяКоманды = "NativePrint" Тогда
        Сообщить("Varник: Поток вывода");
    Иначе
        Сообщить("Varenik: Неизвестная команда - " + ИмяКоманды);
    КонецЕсли;
КонецПроцедуры

// Механизм создания классов (имитация Java в среде BSL)
// Параметры:
//   ИмяКласса - Строка - Название класса
//   ИмяПеременной - Строка - Название переменной для сохранения объекта
Процедура СоздатьОбъект(ИмяКласса, ИмяПеременной)
    НовыйОбъект = Новый Структура;
    НовыйОбъект.Вставить("__Class", ИмяКласса);
    НовыйОбъект.Вставить("__Created", ТекущаяДатаСеанса());
    
    // Автоматический вызов конструктора (фишка Java)
    Сообщить("Varenik: Вызов constructor() для класса " + ИмяКласса);
    
    ПамятьОбъектов.Вставить(ИмяПеременной, НовыйОбъект);
КонецПроцедуры