// ==========================================
// Varenik Engine v1.0 - Syntax Parser
// Логика: Превращает поток слов в структуру команд
// ==========================================

Перем ТекущийИндекс;
Перем СписокТокенов;

// Основная функция парсинга
// Параметры:
//   ВходящиеТокены - Массив - Список токенов от лексера
// Возвращаемое значение:
//   Массив - Дерево выполнения программы
Функция СформироватьДеревоВыполнения(ВходящиеТокены) Экспорт
    СписокТокенов = ВходящиеТокены;
    ТекущийИндекс = 0;
    ДеревоПрограммы = Новый Массив;

    Пока ТекущийИндекс < СписокТокенов.Количество() Цикл
        Токен = СписокТокенов[ТекущийИндекс];
        
        // Обработка Классов (Java-стиль)
        Если Токен.Value = "public" Или Токен.Value = "class" Тогда
            ДеревоПрограммы.Добавить(ПарситьКласс());
            
        // Обработка Процедур (BSL-стиль)
        ИначеЕсли Токен.Type = "FUNC_START" Тогда
            ДеревоПрограммы.Добавить(ПарситьФункцию());
            
        // Точка входа (Вызов Main)
        ИначеЕсли Токен.Value = "Main" Тогда
            ДеревоПрограммы.Добавить(Новый Структура("Action, Name", "CALL", "Main"));
            ТекущийИндекс = ТекущийИндекс + 3; // Пропуск Main();
            
        Иначе
            ТекущийИндекс = ТекущийИндекс + 1;
        КонецЕсли;
    КонецЦикла;

    Возврат ДеревоПрограммы;
КонецФункции

// Парсинг функций (поддерживает экспорт и скобки)
// Возвращаемое значение:
//   Структура - Информация о функции с типом, именем и телом
Функция ПарситьФункцию()
    Инфо = Новый Структура("Type, Name, Body", "FUNCTION", "", Новый Массив);
    ТекущийИндекс = ТекущийИндекс + 1; 
    
    // Имя функции
    Инфо.Name = СписокТокенов[ТекущийИндекс].Value;
    
    // Ищем тело функции до "FUNC_END" (КонецПроцедуры)
    Пока ТекущийИндекс < СписокТокенов.Количество() Цикл
        Токен = СписокТокенов[ТекущийИндекс];
        Если Токен.Type = "FUNC_END" Тогда Прервать; КонецЕсли;
        
        // Добавляем команды внутрь функции (упрощенно)
        Если Токен.Type = "LOG_PRINT" Тогда
            Инфо.Body.Добавить(Новый Структура("Action, Value", "PRINT", ПолучитьАргумент()));
        КонецЕсли;
        
        ТекущийИндекс = ТекущийИндекс + 1;
    КонецЦикла;
    
    Возврат Инфо;
КонецФункции

Функция ПолучитьАргумент()
    // Простая логика извлечения текста в скобках
    Пока ТекущийИндекс < СписокТокенов.Количество() Цикл
        Если СписокТокенов[ТекущийИндекс].Type = "IDENTIFIER" Тогда
            Возврат СписокТокенов[ТекущийИндекс].Value;
        КонецЕсли;
        ТекущийИндекс = ТекущийИндекс + 1;
    КонецЦикла;
КонецФункции